---
title: "go ã® container app ã‚’ remote debugging ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹"
emoji: "ğŸ“"
type: "tech"
topics:
  - "docker"
  - "golang"
published: true
---

# ã¯ã˜ã‚ã«


å‰å›ã® [go ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’ dockerize ã—ãŸ](https://zenn.dev/dai_otsuka/articles/498b63ba622eac) ç¶šãã§ã™ã€‚
ã‚¢ãƒ—ãƒªã‚’ ä»®æƒ³åŒ–ã§ããŸã‚‚ã®ã®ã€debugging ã§ããªã„ã¨é–‹ç™ºã§ã¯ä½¿ãˆãªã„ã®ã§
ãã®è¨­å®šã‚’ã—ã¦ã„ãã€‚

æœ¬è¨˜äº‹ã§å¯¾å¿œã—ãŸPRã«ãªã‚Šã¾ã™ã€‚
https://github.com/d-angelo-2049/go-challenge/pull/6


# ç„¡çŸ¥ãªã®ã§ã¾ãšå‹‰å¼·
æ¯åº¦ã®ã“ã¨ã§ã™ãŒèª¿æŸ»ã—ã¦ã¿ãŸã“ã¨ã‚’è¨˜ã™ã€‚
delve ã¨ã„ã†ãƒ‡ãƒãƒƒã‚¬ã‚’ go ã¯ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ãã‚Œã«ã¤ã„ã¦æ”¹ã‚ã¦èª¿ã¹ã‚‹ã€‚

- internal architecture of delve (å†…éƒ¨æ§‹é€ ã‚’ã•ã‚‰ã£ã¨ã¿ã‚‹)
https://speakerdeck.com/aarzilli/internal-architecture-of-delve

- delve ã® document (ä»Šå›ã¯ãŠã‚‚ã«ã“ã£ã¡ã‚’è¦‹ã¾ã—ãŸ)
https://github.com/go-delve/delve/tree/master/Documentation/usage


# Dockerfile ã‚’æ›¸ã„ã¦ã¿ã‚‹
ä»¥å‰ä½œæˆã—ãŸã€ Dockerfile ã« ä¸‹è¨˜ã®å¤‰æ›´ç‚¹ã‚’åŠ ãˆã‚‹ã€‚
- delve ã® install
- remote debug ç”¨ã® port è¨­å®š
- debug èµ·å‹•

```
# syntax=docker/dockerfile:1

##
## Build
##
FROM golang:1.16-buster AS build

# Build Delve
RUN go install github.com/go-delve/delve/cmd/dlv@latest

WORKDIR /app

# Download necessary Go modules
COPY go.mod ./
COPY go.sum ./

RUN go mod download

COPY *.go ./

RUN go build -gcflags="all=-N -l" -o /web-service-gin

##
## Deploy
##
FROM gcr.io/distroless/base-debian10

WORKDIR /

COPY --from=build /web-service-gin /web-service-gin
COPY --from=build /go/bin/dlv /

EXPOSE 8081 40000

USER nonroot:nonroot

ENTRYPOINT ["/dlv", "--listen=:40000", "--headless=true", "--api-version=2", "--accept-multiclient", "exec", "/web-service-gin"]

```

# IDEã§ã®è¨­å®š

:::message
æœ¬ section ã®èª¬æ˜ã¯Goland ã‚’å‰æã¨ã—ã¦è¨˜è¿°ã™ã‚‹ã€‚

:::

## Dockerfile ã® build ã®è¨­å®š
- ä½¿ç”¨ã™ã‚‹Dockerfile ã‚’æŒ‡å®š
- ä»»æ„ã®container name ã‚’ä»˜ä¸
- application ã® trafficã‚’å—ã‘ã¤ã‘ã‚‹ 8080 to 8081 ã¨ remote debugç”¨ã® 40000 to 40000 ã‚’è¨­å®š

![Docker build ã®è¨­å®š](https://storage.googleapis.com/zenn-user-upload/6ccabd0af56a-20220711.png)

## Remote Debug ã®è¨­å®š

- ä»»æ„ã® Name ã‚’ä»˜ä¸
- Host ã‚’ localhost ã¨ã™ã‚‹
- ãƒ‡ãƒãƒƒã‚¬ç”¨ã® port number ã‚’æŒ‡å®š
![Remote Debug ã®è¨­å®š](https://storage.googleapis.com/zenn-user-upload/e96388b5376d-20220711.png)



# ãƒ‡ãƒãƒƒã‚°ã—ã¦ã¿ã‚‹
ã‚ã‹ã‚Šã‚„ã™ã æœ€åˆã«å‘¼ã°ã‚Œã‚‹ router ã®è¨­å®šã®ç®‡æ‰€ã« break point ã‚’å¼µã£ã¦ã¿ã¾ã—ãŸã€‚
ã—ã£ã‹ã‚Šæ­¢ã¾ã£ã¦ãã‚Œã¾ã—ãŸã€‚

![break point ã§æ­¢ã¾ã‚Šã¾ã—ãŸ](https://storage.googleapis.com/zenn-user-upload/4a4ab3294da1-20220711.png)


# ã•ã„ã”ã«
go ã® container app ã‚’ remote debugã€€ã§ãã‚‹ã‚ˆã†ã«ã—ã¦è¦‹ã¾ã—ãŸã€‚
ã“ã‚Œã§ã€local ã§ e2e ã‚’é€šã—ãŸã„æ™‚ã«ã¯ è³‡æã•ãˆç¢ºä¿ã™ã‚Œã°ã€€ç°¡å˜ã«è©¦ã™ã“ã¨ãŒã§ããã†ã§ã™ã€‚
ç¾çŠ¶ data ã¯ array ã®å€¤ã‚’è¿”ã—ã¦ã„ã‚‹ã ã‘ãªã®ã§ã€€æ¬¡å›ä»¥é™ã¯ ã“ã‚Œã‚’ redis ã¨ã‹ã«å¤‰æ›´ã§ããŸã‚‰ã‚ˆã„ãªã¨æ€ã£ã¦ã„ã¾ã™ã€‚
