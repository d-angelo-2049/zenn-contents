---
title: "go ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ dockerize ã—ã¦ã¿ã‚‹"
emoji: "ðŸ§°"
type: "tech"
topics:
  - "docker"
  - "golang"
published: true
published_at: "2022-06-22 23:57"
---

# ã¯ã˜ã‚ã«
ç§ã®PJã§ã¯ æ—¢å­˜ã®CICD stackã®é–‹ç™ºã¨é©ç”¨ãŒé€²ã‚“ã§ãŠã‚Šã€ãã‚Œã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã ã‘ã§æ¸ˆã‚“ã§ã—ã¾ã†ã®ã§ core ãªä»•æ§˜ã®ç†è§£ã¾ã§åŠã‚“ã§ã„ãªã„ã€‚
æ—¥é ƒ æ¥­å‹™ã§ ã‚³ãƒ³ãƒ†ãƒŠ ã‚’ä½¿ã†ã¨ãã¯ ECSã‚„EKSã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ­ã‚°ã‚’ã¿ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒä¸»ã§ã‚ã‚‹ã€‚

ãã“ã§ã€è‡ªåˆ†ã§0ã‹ã‚‰ã‚„ã£ã¦ã¿ã‚ˆã†ã¨æ€ã£ãŸã€‚
ä»Šå›žã¯ ä¿—ä¸–é–“ã® web ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãªã©ãŒã‚ˆãã‚„ã£ã¦ã„ã‚‹ repo ã® dockerize(dockeråŒ–)? ã‚’è©¦ã—ã¦ã„ããŸã„ã€‚


# ç„¡çŸ¥ãªã®ã§ã¾ãšå‹‰å¼·

ã‚ã‹ã£ãŸæ°—ã«ãªã‚‹ã®ãŒä¸€ç•ªæ€–ã„ã®ã§ã¾ãšã¯çŸ¥è­˜ã‚’input ã™ã‚‹
 Dockerfile ã®æ›¸ãæ–¹ã«ã¤ã„ã¦å‹‰å¼·ã™ã‚‹ã€‚
inputã—ãŸã‚‚ã®ã¯ä¸‹è¨˜
- å…¬å¼docker docs ã«ãã‚Œã£ã½ã„ã®ãŒã‚ã£ãŸã€‚ä¸»ã«ã“ã‚ŒãŒå‹‰å¼·ã«ãªã£ãŸã€‚ã“ã‚Œã«æ²¿ã£ã¦ã‚„ã£ã¦ã„ãã®ãŒè‰¯ã•ãã†ã€‚
https://docs.docker.com/language/golang/build-images/

# å­¦ã‚“ã ã“ã¨ã‚’åãå‡ºã—ã¦ã¿ã‚‹
Dockerfileã¯ å„ã€…ã®ç’°å¢ƒã«åˆã£ãŸ docker image ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã€ã©ã®ã‚ˆã†ãªä»•æ§˜ã® imageã«ã™ã‚‹ã‹è¨˜è¿°ã§ãã‚‹ã€‚
ç’°å¢ƒã«å¿…è¦ãª è¤‡æ•°ã® image ã‚’ docker hub ã‹ã‚‰ã‹ãé›†ã‚ã¦æ‰€æœ›ã® imageã‚’ä½œã‚‹éšŽå±¤æ§‹é€ ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã™ã‚‹ã¨ã‚ˆã„ã¨æ€ã‚ã‚Œã‚‹ã€‚

# Dockerfile ã‚’æ›¸ã„ã¦ã¿ã‚‹

â€» 1è¡Œç›®ã¯ docker ã® build kit 1ç³»ã®latestã‚’ä½¿ç”¨ã™ã‚‹ã¨ã„ã†æ„å‘³ã€‚
docker ã® recommend ã‚‰ã—ã„ã®ã§ã“ã‚Œã¯ä»¥å¾Œä½¿ã£ã¦ã„ããŸã„ã€‚

```
# syntax=docker/dockerfile:1

# Alpine is chosen for its small footprint
# compared to Ubuntu
FROM golang:1.16-alpine

WORKDIR /app

# Download necessary Go modules
COPY go.mod ./
COPY go.sum ./

RUN go mod download

COPY *.go ./

RUN go build -o /web-service-gin
EXPOSE 8080

CMD [ "/web-service-gin" ]

```
å†…å®¹ã‚’è¨€èªžåŒ–ã—ã¦ã¿ã‚‹ã€‚
- base imageã¯ go å…¥ã‚Šã® alpineã‚’ä½¿ç”¨(alpineã¯linuxã®ãƒŸãƒ‹ãƒžãƒ ç‰ˆ)
- image ã« work dirã‚’ä½œã‚Šã€ãã“ã« go.mod,go.sum ã‚’ã‚³ãƒ”ãƒ¼ã—ä¾å­˜ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
- ä½œæˆã—ãŸ go file ã‚’ã‚³ãƒ”ãƒ¼ã—ã€ build
- ã‚³ãƒ³ãƒ†ãƒŠãŒãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ 8080 port ã‚’é–‹ã‘ã€buildãƒã‚¤ãƒŠãƒªã‚’ CMDã§å®Ÿè¡Œ

# imageã‚’ buildã—ã¦ã¿ã‚‹

ä½œæˆã—ãŸ Dockerfileã‚’ã‚‚ã¨ã«ã€imageã‚’buildã—ã¦ã¿ã‚‹ã€‚
æ‰“ã£ãŸã‚³ãƒžãƒ³ãƒ‰ã¯ä¸‹è¨˜ã§ã™ã€‚
```
$ docker build --tag go-challenge/web-service-gin .
[+] Building 45.4s (14/15)                                                                                                                                                                                                            
 => [internal] load build definition from Dockerfile                                                                                                                                                                             0.1s
 => => transferring dockerfile: 365B                                                                                                                                                                                             0.0s
 => [internal] load .dockerignore                                                                                                                                                                                                0.0s
 => => transferring context: 2B                                                                                                                                                                                                  0.0s
 => resolve image config for docker.io/docker/dockerfile:1                                                                                                                                                                       9.3s
 => docker-image://docker.io/docker/dockerfile:1@sha256:443aab4ca21183e069e7d8b2dc68006594f40bddf1b15bbd83f5137bd93e80e2                                                                                                         1.9s
 => => resolve docker.io/docker/dockerfile:1@sha256:443aab4ca21183e069e7d8b2dc68006594f40bddf1b15bbd83f5137bd93e80e2                                                                                                             0.0s
 => => sha256:84495a15555de1a8f4738f58268fa8949547068198f8d0fa2a3e3a693d7f923f 2.37kB / 2.37kB                                                                                                                                   0.0s
 => => sha256:09768fef35f2ee387f57e401ae685727d12d1c70c6fd8545a422850167bf1940 9.94MB / 9.94MB                                                                                                                                   1.4s
 => => sha256:443aab4ca21183e069e7d8b2dc68006594f40bddf1b15bbd83f5137bd93e80e2 2.00kB / 2.00kB                                                                                                                                   0.0s
 => => sha256:24d064a369eda7bc7839b6c1c227eac7212d06ca09a8235a4bed467f8acf180d 528B / 528B                                                                                                                                       0.0s
 => => extracting sha256:09768fef35f2ee387f57e401ae685727d12d1c70c6fd8545a422850167bf1940                                                                                                                                        0.3s
 => [internal] load .dockerignore                                                                                                                                                                                                0.0s
 => [internal] load build definition from Dockerfile                                                                                                                                                                             0.0s
 => [internal] load metadata for docker.io/library/golang:1.16-alpine                                                                                                                                                           11.4s
 => [internal] load build context                                                                                                                                                                                                0.0s
 => => transferring context: 4.76kB                                                                                                                                                                                              0.0s
 => [1/7] FROM docker.io/library/golang:1.16-alpine@sha256:5616dca835fa90ef13a843824ba58394dad356b7d56198fb7c93cbe76d7d67fe                                                                                                     15.3s
 => => resolve docker.io/library/golang:1.16-alpine@sha256:5616dca835fa90ef13a843824ba58394dad356b7d56198fb7c93cbe76d7d67fe                                                                                                      0.0s
 => => sha256:5616dca835fa90ef13a843824ba58394dad356b7d56198fb7c93cbe76d7d67fe 1.65kB / 1.65kB                                                                                                                                   0.0s
 => => sha256:9743f230f26d1e300545f0330fd4a514f554c535d967563ee77bf634906502b6 1.36kB / 1.36kB                                                                                                                                   0.0s
 => => sha256:7642119cd16177d874dcbfe1c550affd336dbe4cabb3339ef685ac1d6ec71ccc 5.17kB / 5.17kB                                                                                                                                   0.0s
 => => sha256:59bf1c3509f33515622619af21ed55bbe26d24913cedbca106468a5fb37a50c3 2.82MB / 2.82MB                                                                                                                                   0.6s
 => => sha256:666ba61612fd7c93393f9a5bc1751d8a9929e32d51501dba691da9e8232bc87b 282.16kB / 282.16kB                                                                                                                               0.8s
 => => sha256:8ed8ca4862056a130f714accb3538decfa0663fec84e635d8b5a0a3305353dee 155B / 155B                                                                                                                                       0.6s
 => => extracting sha256:59bf1c3509f33515622619af21ed55bbe26d24913cedbca106468a5fb37a50c3                                                                                                                                        0.1s
 => => sha256:ca4bf87e467a8cacf62c9b01c7d6d43f6ca4bb9b0fc9146fbb906b05aee56cc1 105.89MB / 105.89MB                                                                                                                              11.7s
 => => sha256:0435e09637941e35cccdf9cf9171571811d2fdfe72c27e39543a718d38d28668 156B / 156B                                                                                                                                       0.9s
 => => extracting sha256:666ba61612fd7c93393f9a5bc1751d8a9929e32d51501dba691da9e8232bc87b                                                                                                                                        0.1s
 => => extracting sha256:8ed8ca4862056a130f714accb3538decfa0663fec84e635d8b5a0a3305353dee                                                                                                                                        0.0s
 => => extracting sha256:ca4bf87e467a8cacf62c9b01c7d6d43f6ca4bb9b0fc9146fbb906b05aee56cc1                                                                                                                                        3.2s
 => => extracting sha256:0435e09637941e35cccdf9cf9171571811d2fdfe72c27e39543a718d38d28668                                                                                                                                        0.0s
 => [2/7] WORKDIR /app                                                                                                                                                                                                           1.0s
 => [3/7] COPY go.mod ./                                                                                                                                                                                                         0.0s
 => [4/7] COPY go.sum ./                                                                                                                                                                                                         0.0s
 => [5/7] RUN go mod download                                                                                                                                                                                                    5.9s
 => ERROR [6/7] COPY web-service-gin/*.go ./                                                                                                                                                                                     0.0s
------
 > [6/7] COPY web-service-gin/*.go ./:
------
lstat /var/lib/docker/tmp/buildkit-mount2300658010/web-service-gin: no such file or directory
xdotsuka@JARVIS:~/projects/go-challenge/web-service-gin$ docker build --tag go-challenge/web-service-gin .
[+] Building 6.5s (16/16) FINISHED                                                                                                                                                                                                    
 => [internal] load build definition from Dockerfile                                                                                                                                                                             0.0s
 => => transferring dockerfile: 349B                                                                                                                                                                                             0.0s
 => [internal] load .dockerignore                                                                                                                                                                                                0.0s
 => => transferring context: 2B                                                                                                                                                                                                  0.0s
 => resolve image config for docker.io/docker/dockerfile:1                                                                                                                                                                       1.3s
 => CACHED docker-image://docker.io/docker/dockerfile:1@sha256:443aab4ca21183e069e7d8b2dc68006594f40bddf1b15bbd83f5137bd93e80e2                                                                                                  0.0s
 => [internal] load build definition from Dockerfile                                                                                                                                                                             0.0s
 => [internal] load .dockerignore                                                                                                                                                                                                0.0s
 => [internal] load metadata for docker.io/library/golang:1.16-alpine                                                                                                                                                            1.2s
 => [internal] load build context                                                                                                                                                                                                0.0s
 => => transferring context: 1.81kB                                                                                                                                                                                              0.0s
 => [1/7] FROM docker.io/library/golang:1.16-alpine@sha256:5616dca835fa90ef13a843824ba58394dad356b7d56198fb7c93cbe76d7d67fe                                                                                                      0.0s
 => CACHED [2/7] WORKDIR /app                                                                                                                                                                                                    0.0s
 => CACHED [3/7] COPY go.mod ./                                                                                                                                                                                                  0.0s
 => CACHED [4/7] COPY go.sum ./                                                                                                                                                                                                  0.0s
 => CACHED [5/7] RUN go mod download                                                                                                                                                                                             0.0s
 => [6/7] COPY *.go ./                                                                                                                                                                                                           0.0s
 => [7/7] RUN go build -o /web-service-gin                                                                                                                                                                                       2.5s
 => exporting to image                                                                                                                                                                                                           1.1s
 => => exporting layers                                                                                                                                                                                                          1.1s
 => => writing image sha256:9268c88b01e46edca48f6d1a1e7bb62529385707ab654c55f60b8f094d825cdb                                                                                                                                     0.0s
 => => naming to docker.io/go-challenge/web-service-gin                                                                                                                                                                          0.0s

Use 'docker scan' to run Snyk tests against images to find vulnerabilities and learn how to fix them


```

imageãŒä½œã‚Œã¾ã—ãŸã€‚

```
$ docker image ls | grep go-challenge
go-challenge/web-service-gin                              latest                                                                       9268c88b01e4   15 minutes ago   451MB

```

# Multi-stage builds ã¨ã‚„ã‚‰
å‰ã® section ã§ image ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
ã—ã‹ã—ã€ image ã® size ã‚’ç¢ºèªã™ã‚‹ã¨ 451MB ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚
gin ã§ sample ç¨‹åº¦ã«ä½œã£ãŸAPIã§ã•ãˆã“ã®ç¨‹åº¦ãªã®ã§ã‚„ã¯ã‚Š base imageã‚‚å«ã‚ã¦bundleã™ã‚‹ã¨ sizeãŒå¤§ãããªã‚Šã‚„ã™ã„ã‚ˆã†ã§ã™ã€‚
ãã“ã§ docker ã«ã¯ Multi-stage builds ã¨ã„ã†ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚
Build, Deployã® stageã”ã¨ã« image ã‚’åˆ†ã‘ã‚‹ã“ã¨ãŒã§ãã€ãã® stage ã§å¿…è¦ãªã‚‚ã®ã‚’åˆ¥ã€…ã«æ›¸ãã“ã¨ãŒã§ãã‚‹ãã†ã§ã™ã€‚

goã¯ Build stageã§ build ã—ãŸ ãƒã‚¤ãƒŠãƒªã•ãˆé…ç½®ã™ã‚Œã°å‹•ä½œã™ã‚‹ã€‚
ãã®ãŸã‚ã€Deploy stage ã§ã¯ base imageã‹ã‚‰ golang ã‚’æŽ’é™¤ã§ãã‚‹ã®ã§ã™ã€‚

è©³ã—ãã¯ä¸‹è¨˜
https://docs.docker.com/language/golang/build-images/#multi-stage-builds

```
# syntax=docker/dockerfile:1

##
## Build
##
FROM golang:1.16-buster AS build

WORKDIR /app

# Download necessary Go modules
COPY go.mod ./
COPY go.sum ./

RUN go mod download

COPY *.go ./

RUN go build -o /web-service-gin

##
## Deploy
##
FROM gcr.io/distroless/base-debian10

WORKDIR /

COPY --from=build /web-service-gin /web-service-gin

EXPOSE 8080

USER nonroot:nonroot

ENTRYPOINT ["/web-service-gin"]

```

```
$ docker image ls | grep go-challenge
go-challenge/web-service-gin                              latest                                                                       9594d4ff3919   37 seconds ago   28.9MB
```

28.9MBã¾ã§å°ã•ããªã£ãŸã€‚ã“ã‚Œã¯ä»Šå¾Œã‚‚æ´»ç”¨ã—ã¦ã„ããŸã„ã€‚
ã¡ãªã¿ã«ä»Šå›žç”¨ã„ãŸ base image ã¯ package managerã‚„ shellã•ãˆæœ‰ã—ã¦ã„ãªã„è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªã‚‚ã®ã‚‰ã—ã„ã€‚prodã§ä½¿ã†ãŸã‚ã«ã¯ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ä½œã‚Šã“ã¾ã‚“ã¨åŽ³ã—ã„ã§ã™ã­ã€‚
https://github.com/GoogleContainerTools/distroless

## ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚‹
ã•ã‚ãŠã¾ã¡ã‹ã­ã€docker run ã™ã‚‹ã€‚portã¯ 8080 to 8081ã§é–‹ã‘ã‚‹ã€‚
```
$ docker run -d --publish 8080:8081 go-challenge/web-service-gin
6044531d60171ef494d52096f10b9b9c6e3588e2c3ef07bac850480cb6729b05
```

ãã—ã¦ ç–Žé€šç¢ºèª
```
curl -v  http://localhost:8080/albums
*   Trying 127.0.0.1:8080...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8080 (#0)
> GET /albums HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/7.68.0
> Accept: */*
> 
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
< Content-Type: application/json; charset=utf-8
< Date: Wed, 22 Jun 2022 14:35:45 GMT
< Content-Length: 382
< 
[
    {
        "id": "1",
        "title": "Blue Train",
        "artist": "John Coltrane",
        "price": 56.99
    },
    {
        "id": "2",
        "title": "Jeru",
        "artist": "Gerry Mulligan",
        "price": 17.99
    },
    {
        "id": "3",
        "title": "Sarah Vaughan and Clifford Brown",
        "artist": "Sarah Vaughan",
        "price": 39.99
    }
* Connection #0 to host localhost left intact

```
äº‹å‰ã« arrayã«ç™»éŒ²ã—ã¦ãŠã„ãŸ ã‚‚ã®ãŒå–å¾—ã§ãã¾ã—ãŸã€‚
dockerizeå®Œäº†w

# ã•ã„ã”ã«

go ã® sample ã‚’ docker ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§å‹•ä½œã•ã›ã‚‹ã“ã¨ãŒã§ããŸã€‚
æ¬¡ã¯ local machine ã§ build debug ã™ã‚‹ã®ã‚’ docker ä¸Šã§ã©ã†ã‚„ã‚‹ã®ã‹æ°—ã«ãªã‚‹ã®ã§ãã“ã‚’èª¿ã¹ãŸã„ã€‚